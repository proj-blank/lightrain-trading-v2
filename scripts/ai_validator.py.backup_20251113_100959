#!/usr/bin/env python3
"""
AI Position Validator - Post-Entry Validation
Analyzes entered positions and provides second opinion using Claude
"""

import os
import requests
from datetime import datetime
from dotenv import load_dotenv

# Load environment variables first
load_dotenv('/home/ubuntu/trading/.env')

# Get Anthropic API key
ANTHROPIC_API_KEY = os.getenv('ANTHROPIC_API_KEY')


def validate_position(ticker, entry_price, technical_score, rs_rating, indicators_fired, df):
    """
    Ask AI to validate a position we just entered

    Args:
        ticker: Stock ticker (e.g., 'RELIANCE.NS')
        entry_price: Entry price in rupees
        technical_score: Technical signal score (0-100)
        rs_rating: Relative strength rating (0-100)
        indicators_fired: List of indicators that triggered (e.g., ['RSI', 'MACD', 'Volume'])
        df: Price dataframe with recent history

    Returns:
        {
            'agrees': True/False,
            'confidence': 0.85,
            'reasoning': "Strong momentum confirmed, sector tailwinds...",
            'verdict': 'AGREE' | 'CAUTION' | 'DISAGREE'
        }
    """

    try:
        # Extract recent price action
        recent_prices = list(df["Close"].tail(5)) if not df.empty and "Close" in df.columns else [entry_price]*5
        recent_volumes = list(df["Volume"].tail(5)) if not df.empty and "Volume" in df.columns else []

        # Calculate price change
        price_change_5d = ((recent_prices[-1] - recent_prices[0]) / recent_prices[0] * 100) if len(recent_prices) >= 5 else 0

        # Format indicators
        indicators_str = ', '.join(indicators_fired) if indicators_fired else 'Multiple signals'

        # Construct prompt
        prompt = f"""You are a professional stock analyst validating a trading system's entry decision.

**Position Entered:**
- Ticker: {ticker}
- Entry Price: Rs.{entry_price:,.2f}
- Technical Score: {technical_score}/100
- Relative Strength: {rs_rating}/100
- Signals Fired: {indicators_str}

**Recent Price Action (Last 5 Days):**
- Prices: {[f'Rs.{p:.2f}' for p in recent_prices]}
- 5-Day Change: {price_change_5d:+.2f}%

**Your Task:**
Provide a concise second opinion on this entry in exactly this format:

VERDICT: [AGREE/CAUTION/DISAGREE]
CONFIDENCE: [0.00-1.00]
REASONING: [One sentence explaining your view]

Guidelines:
- AGREE: Technical setup is sound, good risk/reward
- CAUTION: Setup is okay but has notable risks
- DISAGREE: Better opportunities exist or high risk

Be direct and specific. Focus on what matters most."""

        # Call Claude API
        url = "https://api.anthropic.com/v1/messages"
        headers = {
            "x-api-key": ANTHROPIC_API_KEY,
            "anthropic-version": "2023-06-01",
            "content-type": "application/json"
        }

        payload = {
            "model": "claude-3-haiku-20240307",
            "max_tokens": 200,
            "messages": [
                {
                    "role": "user",
                    "content": prompt
                }
            ]
        }

        response = requests.post(url, json=payload, headers=headers, timeout=30)

        if response.status_code == 200:
            ai_response = response.json()['content'][0]['text']
            return parse_ai_response(ai_response)
        else:
            error_msg = response.text
            print(f"⚠️ Claude API error: {response.status_code}")
            print(f"   Response: {error_msg[:200]}")
            return {
                'agrees': None,
                'confidence': 0.5,
                'reasoning': f'AI analysis unavailable (API error {response.status_code})',
                'verdict': 'UNKNOWN'
            }

    except Exception as e:
        print(f"AI validation failed for {ticker}: {e}")
        # Return neutral fallback
        return {
            'agrees': None,
            'confidence': 0.5,
            'reasoning': f"AI analysis unavailable: {str(e)[:50]}",
            'verdict': 'UNKNOWN'
        }


def parse_ai_response(response_text):
    """
    Parse AI response into structured format

    Expected format:
    VERDICT: AGREE
    CONFIDENCE: 0.85
    REASONING: Strong momentum confirmed...
    """

    verdict = 'UNKNOWN'
    confidence = 0.5
    reasoning = 'AI response parsing failed'

    try:
        lines = response_text.strip().split('\n')

        for line in lines:
            if line.startswith('VERDICT:'):
                verdict = line.split(':', 1)[1].strip().upper()
            elif line.startswith('CONFIDENCE:'):
                conf_str = line.split(':', 1)[1].strip()
                confidence = float(conf_str)
            elif line.startswith('REASONING:'):
                reasoning = line.split(':', 1)[1].strip()

        # Map verdict to agrees boolean
        agrees = None
        if verdict == 'AGREE':
            agrees = True
        elif verdict == 'DISAGREE':
            agrees = False
        elif verdict == 'CAUTION':
            agrees = None  # Neither agree nor disagree

        return {
            'agrees': agrees,
            'confidence': confidence,
            'reasoning': reasoning,
            'verdict': verdict
        }

    except Exception as e:
        print(f"Failed to parse AI response: {e}")
        return {
            'agrees': None,
            'confidence': 0.5,
            'reasoning': response_text[:100] if response_text else 'Parse error',
            'verdict': 'UNKNOWN'
        }


def get_verdict_emoji(verdict):
    """Get emoji for verdict"""
    emoji_map = {
        'AGREE': '✅',
        'CAUTION': '⚠️',
        'DISAGREE': '❌',
        'UNKNOWN': '❓'
    }
    return emoji_map.get(verdict, '❓')


if __name__ == "__main__":
    # Test with sample data
    import pandas as pd

    # Create sample dataframe
    test_df = pd.DataFrame({
        'Close': [100, 102, 105, 108, 110],
        'Volume': [1000000, 1200000, 1500000, 1800000, 2000000]
    })

    result = validate_position(
        ticker='RELIANCE.NS',
        entry_price=110.0,
        technical_score=75,
        rs_rating=90,
        indicators_fired=['RSI', 'MACD', 'Volume'],
        df=test_df
    )

    print("Test Result:")
    print(f"  Verdict: {result['verdict']}")
    print(f"  Agrees: {result['agrees']}")
    print(f"  Confidence: {result['confidence']}")
    print(f"  Reasoning: {result['reasoning']}")
